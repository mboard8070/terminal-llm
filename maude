#!/bin/bash
# MAUDE - Multi-Agent Unified Dispatch Engine
# Starts the full agent system: MAUDE + Claude Code + Permission Watcher

cd /home/mboard76/nvidia-workbench/terminal-llm

# Clear kill switch if it exists
rm -f ~/.config/maude/stop
mkdir -p ~/.config/maude

# Initialize activity log
echo "[$(date '+%Y-%m-%d %H:%M:%S')] [SYSTEM] Agent system starting" >> ~/.config/maude/activity.log

# Start Claude Code if not running
if ! tmux has-session -t claude 2>/dev/null; then
    echo "Starting Claude Code..."
    tmux new-session -d -s claude
    tmux send-keys -t claude "cd /home/mboard76/nvidia-workbench/terminal-llm && claude" Enter
    sleep 2
fi

# Start Permission Watcher if not running
if ! tmux has-session -t watcher 2>/dev/null; then
    echo "Starting permission watcher..."
    tmux new-session -d -s watcher
    tmux send-keys -t watcher "cd /home/mboard76/nvidia-workbench/terminal-llm && source venv/bin/activate && python3 claude_watcher.py" Enter
    sleep 1
fi

# Start MAUDE in tmux if not running, then attach
if ! tmux has-session -t maude 2>/dev/null; then
    echo "Starting MAUDE..."
    tmux new-session -d -s maude
    tmux send-keys -t maude "cd /home/mboard76/nvidia-workbench/terminal-llm && source venv/bin/activate && python3 chat_local.py" Enter
    sleep 1
fi

echo ""
echo "╔═══════════════════════════════════════════════════════════════╗"
echo "║  MAUDE Agent System                                           ║"
echo "╠═══════════════════════════════════════════════════════════════╣"
echo "║  Sessions:                                                    ║"
echo "║    maude   - Your main interface                              ║"
echo "║    claude  - Claude Code (for complex tasks)                  ║"
echo "║    watcher - Permission bridge                                ║"
echo "╠═══════════════════════════════════════════════════════════════╣"
echo "║  Commands:                                                    ║"
echo "║    Ctrl+B then D     - Detach from session                    ║"
echo "║    Ctrl+B then s     - Switch sessions                        ║"
echo "║    tmux attach -t X  - Attach to session X                    ║"
echo "╠═══════════════════════════════════════════════════════════════╣"
echo "║  Logs:  tail -f ~/.config/maude/activity.log                  ║"
echo "║  Stop:  touch ~/.config/maude/stop                            ║"
echo "╚═══════════════════════════════════════════════════════════════╝"
echo ""

# Attach to MAUDE session
tmux attach -t maude
